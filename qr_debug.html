<!DOCTYPE html>
<html>
<head>
    <title>Evolution API QR Code Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .instance { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .status { background: #e3f2fd; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .qr-container { text-align: center; margin: 20px 0; }
        .error { color: red; }
        .success { color: green; }
        iframe { width: 100%; height: 600px; border: 1px solid #ccc; }
        button { background: #1976d2; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #1565c0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Evolution API QR Code Debug</h1>

        <div class="status">
            <h3>API Configuration:</h3>
            <p><strong>Base URL:</strong> http://localhost:8080</p>
            <p><strong>API Key:</strong> 429683C4C977415CAAFCCE10F7D57E11</p>
            <p><strong>Instance:</strong> gust-ia-v4</p>
            <p><strong>Number:</strong> 221773387902</p>
        </div>

        <div class="qr-container">
            <button onclick="checkInstance()">Check Instance Status</button>
            <button onclick="tryQRCode()">Try Get QR Code</button>
            <button onclick="openManager()">Open Manager in New Tab</button>
        </div>

        <div id="results"></div>

        <h3>Manager Interface:</h3>
        <iframe src="http://localhost:8080/manager" id="manager-frame"></iframe>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080';
        const API_KEY = '429683C4C977415CAAFCCE10F7D57E11';
        const INSTANCE_NAME = 'gust-ia-v4';

        async function makeRequest(endpoint, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                'apikey': API_KEY,
                ...options.headers
            };

            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    ...options,
                    headers
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                return await response.json();
            } catch (error) {
                console.error('Request failed:', error);
                return { error: error.message };
            }
        }

        async function checkInstance() {
            const result = await makeRequest(`/instance/fetchInstances?instanceName=${INSTANCE_NAME}`);

            let html = '<div class="instance">';
            html += '<h3>Instance Status:</h3>';

            if (result.error) {
                html += `<p class="error">Error: ${result.error}</p>`;
            } else if (result && result.length > 0) {
                const instance = result[0];
                html += `<p><strong>Name:</strong> ${instance.name}</p>`;
                html += `<p><strong>Status:</strong> ${instance.connectionStatus}</p>`;
                html += `<p><strong>Number:</strong> ${instance.number}</p>`;
                html += `<p><strong>Integration:</strong> ${instance.integration}</p>`;
                html += `<p><strong>Created:</strong> ${instance.createdAt}</p>`;

                if (instance.connectionStatus === 'open') {
                    html += '<p class="success">‚úÖ WhatsApp Connected!</p>';
                }
            } else {
                html += '<p class="error">No instance found</p>';
            }

            html += '</div>';
            document.getElementById('results').innerHTML = html;
        }

        async function tryQRCode() {
            let html = '<div class="instance">';
            html += '<h3>QR Code Attempts:</h3>';

            // Try different possible QR code endpoints
            const endpoints = [
                { method: 'GET', url: `/instance/fetchInstances?instanceName=${INSTANCE_NAME}`, name: 'Check Instance for QR' },
                { method: 'POST', url: `/instance/create`, name: 'Recreate Instance',
                  body: JSON.stringify({
                    instanceName: 'gust-ia-v5',
                    integration: 'WHATSAPP-BAILEYS',
                    token: 'gust-ia-token-v5',
                    number: '221773387902',
                    qrcode: true
                  })
                }
            ];

            for (const endpoint of endpoints) {
                html += `<p><strong>Trying:</strong> ${endpoint.name}</p>`;

                const options = {
                    method: endpoint.method,
                    headers: { 'Content-Type': 'application/json' }
                };

                if (endpoint.body) {
                    options.body = endpoint.body;
                }

                const result = await makeRequest(endpoint.url, options);

                if (result.error) {
                    html += `<p class="error">‚ùå Failed: ${result.error}</p>`;
                } else {
                    html += `<p class="success">‚úÖ Success!</p>`;
                    html += `<pre>${JSON.stringify(result, null, 2)}</pre>`;

                    // Check if this response has QR code
                    if (result.qrcode || (result.instance && result.instance.status === 'connecting')) {
                        html += '<p>üîç QR code generation initiated!</p>';
                    }
                }
                html += '<hr>';
            }

            html += '</div>';
            document.getElementById('results').innerHTML = html;
        }

        function openManager() {
            window.open('http://localhost:8080/manager', '_blank');
        }

        // Auto-check on load
        window.onload = function() {
            checkInstance();
        };
    </script>
</body>
</html>