# Data Model: WhatsApp AI Concierge Service

**Branch**: `001-projet-concierge-ia` | **Date**: 2025-09-16

## Entity Relationship Diagram

```
User ──┬── User_Session ──── Session
       │                   │
       ├── User_Service    ├── Interaction
       │                   │
       └── User_Role       └── Artifact

Service ──┬── Service_Context
           │
           └── Service_Info

Role ─────── User_Role

Media ────── Interaction
```

## Core Entities

### User
Represents WhatsApp users in the system

**Fields**:
- `id` (UUID, Primary Key)
- `phone_number` (String, Unique, Indexed) - WhatsApp phone number
- `name` (String, Optional) - User display name
- `created_at` (Timestamp) - Account creation timestamp
- `updated_at` (Timestamp) - Last update timestamp
- `is_active` (Boolean, Default: true) - Account status

**Validation Rules**:
- Phone number must be in E.164 format
- Phone number must be unique
- Name length max 255 characters

### Service
Represents available services in the concierge system

**Fields**:
- `id` (UUID, Primary Key)
- `name` (String, Unique) - Service name (e.g., "RENSEIGNEMENT", "CATECHESE")
- `display_name` (String) - User-friendly display name
- `description` (Text) - Service description
- `trigger_keywords` (Array[String]) - Keywords that trigger this service
- `trigger_type` (Enum: KEYWORD, PHONE_ROLE, INTRINSIC_ID) - How service is triggered
- `processing_type` (Enum: AI, HUMAN, HYBRID) - How requests are processed
- `artifact_types` (Array[String]) - Types of artifacts produced
- `intrinsic_id_field` (String, Optional) - Field name for intrinsic ID (e.g., "code_parent")
- `is_active` (Boolean, Default: true) - Service status
- `created_at` (Timestamp) - Service creation timestamp
- `updated_at` (Timestamp) - Last update timestamp

**Validation Rules**:
- Name must be unique
- Trigger keywords cannot be empty
- At least one artifact type must be specified

### Session
Represents conversation sessions with users

**Fields**:
- `id` (UUID, Primary Key)
- `user_id` (UUID, Foreign Key → User) - Associated user
- `service_id` (UUID, Foreign Key → Service, Optional) - Current service context
- `status` (Enum: ACTIVE, COMPLETED, EXPIRED, HANDED_OFF) - Session status
- `state` (JSON) - Current conversation state and collected data
- `metadata` (JSON) - Additional session metadata
- `expires_at` (Timestamp, Optional) - Session expiration time
- `created_at` (Timestamp) - Session start timestamp
- `updated_at` (Timestamp) - Last activity timestamp
- `completed_at` (Timestamp, Optional) - Session completion timestamp

**Validation Rules**:
- User ID must reference existing user
- Service ID must reference existing service if provided
- State must be valid JSON

### Interaction
Represents individual message interactions

**Fields**:
- `id` (UUID, Primary Key)
- `session_id` (UUID, Foreign Key → Session) - Associated session
- `message_type` (Enum: USER, SYSTEM, AI) - Who sent the message
- `content` (Text) - Message content
- `media_url` (String, Optional) - URL to attached media
- `media_type` (String, Optional) - Type of media (image, document, etc.)
- `metadata` (JSON) - Additional interaction metadata
- `created_at` (Timestamp) - Message timestamp

**Validation Rules**:
- Session ID must reference existing session
- Content cannot be empty for text messages
- Media URL must be valid URL if provided

### Artifact
Represents outputs generated by the system

**Fields**:
- `id` (UUID, Primary Key)
- `session_id` (UUID, Foreign Key → Session) - Associated session
- `service_id` (UUID, Foreign Key → Service) - Service that generated artifact
- `type` (String) - Artifact type (response, link, document, ticket)
- `content` (Text, Optional) - Text content
- `file_url` (String, Optional) - URL to generated file
- `metadata` (JSON) - Additional artifact metadata
- `created_at` (Timestamp) - Artifact creation timestamp

**Validation Rules**:
- Session ID must reference existing session
- Service ID must reference existing service
- Either content or file_url must be provided

## Support Entities

### User_Service
Maps users to services they can access

**Fields**:
- `id` (UUID, Primary Key)
- `user_id` (UUID, Foreign Key → User) - Associated user
- `service_id` (UUID, Foreign Key → Service) - Associated service
- `role` (Enum: CLIENT, ADMIN, SUPER_ADMIN) - User role for this service
- `intrinsic_id` (String, Optional) - Service-specific identifier (e.g., code_parent)
- `created_at` (Timestamp) - Mapping creation timestamp
- `updated_at` (Timestamp) - Last update timestamp

**Validation Rules**:
- User ID and Service ID combination must be unique
- Role must be valid enum value
- Intrinsic ID required for services that use intrinsic identification

### User_Role
Defines user roles across services

**Fields**:
- `id` (UUID, Primary Key)
- `name` (String, Unique) - Role name
- `description` (Text) - Role description
- `permissions` (JSON) - Role permissions
- `created_at` (Timestamp) - Role creation timestamp

### Service_Context
Service-specific configuration and prompts

**Fields**:
- `id` (UUID, Primary Key)
- `service_id` (UUID, Foreign Key → Service) - Associated service
- `system_prompt` (Text) - AI system prompt for this service
- `service_prompts` (JSON) - Service-specific prompts and templates
- `validation_rules` (JSON) - Data validation rules
- `required_fields` (Array[String]) - Fields required for this service
- `created_at` (Timestamp) - Context creation timestamp
- `updated_at` (Timestamp) - Last update timestamp

**Validation Rules**:
- Service ID must be unique
- System prompt cannot be empty

### Service_Info
Time-bound information for services

**Fields**:
- `id` (UUID, Primary Key)
- `service_id` (UUID, Foreign Key → Service) - Associated service
- `title` (String) - Information title
- `content` (Text) - Information content
- `start_date` (Timestamp, Optional) - When information becomes active
- `expiry_date` (Timestamp, Optional) - When information expires
- `is_active` (Boolean, Default: true) - Information status
- `created_at` (Timestamp) - Information creation timestamp
- `updated_at` (Timestamp) - Last update timestamp

**Validation Rules**:
- Service ID must reference existing service
- Title cannot be empty
- Content cannot be empty
- If expiry_date is provided, must be after start_date

### Media
Handles media attachments

**Fields**:
- `id` (UUID, Primary Key)
- `filename` (String) - Original filename
- `file_path` (String) - Storage path
- `mime_type` (String) - MIME type
- `size_bytes` (Integer) - File size in bytes
- `uploaded_at` (Timestamp) - Upload timestamp
- `expires_at` (Timestamp, Optional) - When file should be deleted

**Validation Rules**:
- File path must be unique
- MIME type must be valid
- Size must be positive integer

## State Transitions

### Session Status Flow
```
ACTIVE ────┐
    │      ↓
    │    COMPLETED
    │      ↓
    │    EXPIRED
    │
    └──→ HANDED_OFF
```

**Rules**:
- ACTIVE: Default state for new sessions
- COMPLETED: Normal termination with artifacts generated
- EXPIRED: Session timeout or manual expiration
- HANDED_OFF: Transferred to human agent

### Service Processing Types
- **AI**: Fully automated processing with Claude SDK
- **HUMAN**: Requires human intervention
- **HYBRID**: AI processing with human fallback

## Indexing Strategy

### Primary Indexes
- `users.phone_number` (Unique) - Fast user lookup
- `sessions.user_id` - User session lookup
- `sessions.status` - Active session filtering
- `interactions.session_id` - Conversation history
- `services.name` (Unique) - Service lookup
- `services.is_active` - Active service filtering

### Secondary Indexes
- `sessions.created_at` - Session time-based queries
- `interactions.created_at` - Message timeline
- `artifacts.created_at` - Artifact generation history
- `service_info.start_date` - Time-based information filtering
- `service_info.expiry_date` - Expired information cleanup

## Data Integrity Constraints

### Foreign Key Constraints
- All foreign keys must reference existing records
- ON DELETE CASCADE for dependent records
- ON UPDATE CASCADE for ID changes

### Unique Constraints
- User phone numbers must be unique
- Service names must be unique
- User-Service role combinations must be unique
- Media file paths must be unique

### Check Constraints
- Phone numbers must match E.164 format
- Timestamps must be logical (created_at ≤ updated_at)
- File sizes must be positive
- Enum values must be valid

## JSON Schema Definitions

### Session State Schema
```json
{
  "type": "object",
  "properties": {
    "current_step": {"type": "string"},
    "collected_data": {"type": "object"},
    "validation_status": {"type": "string"},
    "retry_count": {"type": "integer", "minimum": 0}
  }
}
```

### Service Context Schema
```json
{
  "type": "object",
  "properties": {
    "required_fields": {
      "type": "array",
      "items": {"type": "string"}
    },
    "validation_rules": {"type": "object"},
    "prompts": {"type": "object"}
  }
}
```

## Migration Strategy

### Initial Migration
1. Create core tables (User, Service, Session, Interaction, Artifact)
2. Create support tables (User_Service, Service_Context, Service_Info, User_Role, Media)
3. Add indexes and constraints
4. Insert initial service definitions
4. Insert default roles and permissions

### Future Migrations
- Add new service types as needed
- Extend artifact types for new outputs
- Add analytics and reporting tables
- Implement soft delete functionality